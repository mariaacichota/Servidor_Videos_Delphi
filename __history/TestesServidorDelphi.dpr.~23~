program TestesServidorDelphi;

{$APPTYPE CONSOLE}

uses
  System.SysUtils,
  DUnitX.Loggers.Console,
  DUnitX.TestFramework,
  DUnitX.Loggers.XML.NUnit,
  DUnitX.Loggers.XML.JUnit,
  IdHTTPServer,
  IdSSLOpenSSL,  // Adicione esta unidade para suporte SSL
  Server.Testes in 'Server.Testes.pas';

var
  Server: TIdHTTPServer;
  Runner: ITestRunner;
  ConsoleLogger: TDUnitXConsoleLogger;
  SSLHandler: TIdSSLIOHandlerSocketOpenSSL;

begin
  try
    // Inicializa o servidor com suporte a SSL
    Server := TIdHTTPServer.Create(nil);
    SSLHandler := TIdSSLIOHandlerSocketOpenSSL.Create(nil);
    try
      SSLHandler.SSLOptions.Method := sslvTLSv1_2;
      SSLHandler.SSLOptions.Mode := sslmServer;
      Server.IOHandler := SSLHandler;
      Server.DefaultPort := 8080;
      Server.Active := True;

      // Cria uma instância do runner de testes
      Runner := TDUnitX.CreateRunner;

      // Adiciona um logger de console
      ConsoleLogger := TDUnitXConsoleLogger.Create(true);
      runner.AddLogger(consoleLogger);

      // Executa os testes
      runner.Execute;
    finally
      Server.Free;
      SSLHandler.Free;
    end;
  except
    on E: Exception do
      Writeln(E.ClassName, ': ', E.Message);
  end;
end.
